const MaxPopupLifetime=450,TabActivatedOnStartupDelay=750,TabRemovedDelay=1e3,MinTabDwellTime=750,RestartDelay=1e4,BadgeColors={light:{normal:"#a0a0a0",inverted:"#3367d6"},dark:{normal:"#666",inverted:"#3367d6"}},IconPaths={light:{normal:{path:{19:"img/icon-19.png",38:"img/icon-38.png"}},inverted:{path:{19:"img/icon-19-inverted.png",38:"img/icon-38-inverted.png"}}}};IconPaths.dark={normal:IconPaths.light.inverted,inverted:IconPaths.light.normal};const Manifest=chrome.runtime.getManifest();let gStartingUp=!1,gIgnoreNextTabActivation=!1,gInstalledPromise=new Promise((e=>{chrome.runtime.onInstalled.addListener((t=>e(t)))}));function debounce(e,t,n=this){let o,a;const r=(...i)=>{a=()=>(r.cancel(),e.apply(n,i)),clearTimeout(o),o=setTimeout(a,t)};return r.cancel=()=>{clearTimeout(o),o=null,a=null},r.execute=()=>Promise.resolve(a&&a()),r}chrome.runtime.onStartup.addListener((()=>{const e=debounce((()=>{chrome.tabs.onActivated.removeListener(e),DEBUG&&console.log("==== last onActivated"),gStartingUp&&require(["background/recent-tabs"],(function(e){return e.updateAll().then((()=>{DEBUG&&console.log("===== updateAll done"),gStartingUp=!1}))}))}),750);DEBUG&&console.log("== onStartup"),gStartingUp=!0,chrome.tabs.onActivated.addListener(e)})),require(["cp","background/recent-tabs","background/page-trackers","background/quickey-storage","background/settings","background/constants"],(function(e,t,n,o,a,r){const i=n.background;let s,c,d,g,l=0,u=!1,m=!1,h=Promise.resolve(),p=!0,b=!0;const v=debounce((({tabId:n})=>e.tabs.get(n).then(t.add).catch((e=>{e&&e.message&&0!=e.message.indexOf("No tab")&&i.exception(e)}))),750),w=debounce(((e,n)=>{gStartingUp||t.remove(e,n)}),1e3);function I(t){gIgnoreNextTabActivation||(m&&function(){const t=r.IsDev?D:S,{paths:n,badgeColor:o}=U(!0);p=!1,clearTimeout(s),s=setTimeout(t,750),Promise.all([b?e.browserAction.setBadgeBackgroundColor({color:o}):e.browserAction.setIcon(n)]).catch(i.exception)}(),m=!1,v(t)),gIgnoreNextTabActivation=!1}function f(e){const n=p?"single":"repeated";switch(e){case"1-previous-tab":m=!0,t.navigate(-1),i.event("recents","previous",n);break;case"2-next-tab":m=!0,t.navigate(1),i.event("recents","next",n);break;case"30-toggle-recent-tabs":x(!0)}}function x(e){h=h.then(v.execute).then(t.toggle).then(v.execute).then((()=>i.event("recents",e?"toggle-shortcut":"toggle")))}function D(){S(),v.execute().then((()=>o.get((({tabIDs:t,tabsByID:n})=>{const[o,a]=t.slice(-2),r=n[o],i=n[a];r&&i&&r.windowId!==i.windowId&&e.tabs.get(o).then((({active:t})=>{t||(gIgnoreNextTabActivation=!0,e.tabs.update(o,{active:!0}).catch(console.error))}))}))))}function U(e){const t=matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light",n=e?"inverted":"normal";return{paths:IconPaths[t][n],badgeColor:BadgeColors[t][n]}}function S(){const{paths:t,badgeColor:n}=U();return p=!0,e.browserAction.setIcon(t),Promise.all([e.browserAction.setBadgeBackgroundColor({color:n}),e.browserAction.setIcon(t)]).catch(i.exception)}function T(t=0){l+=t;const n=Manifest.short_name,o=b?String(l):"",a=b?`${n} - ${l} open tab${1==l?"":"s"}`:n;return Promise.all([e.browserAction.setBadgeText({text:o}),e.browserAction.setTitle({title:a})]).catch(i.exception)}chrome.tabs.onActivated.addListener((e=>{gStartingUp||I(e)})),chrome.tabs.onCreated.addListener((e=>{T(1),gStartingUp||e.active||t.add(e,!0)})),chrome.tabs.onRemoved.addListener(((e,t)=>{T(-1),w(e,t)})),chrome.tabs.onReplaced.addListener(((e,n)=>{gStartingUp||t.replace(n,e)})),chrome.windows.onFocusChanged.addListener((t=>{gStartingUp||t==chrome.windows.WINDOW_ID_NONE||t==c||(c=t,e.tabs.query({active:!0,windowId:t}).then((([e={}])=>I({tabId:e.id}))))})),chrome.commands.onCommand.addListener((e=>{gStartingUp?(gStartingUp=!1,t.updateAll().then((()=>f(e)))):f(e)})),chrome.runtime.onConnect.addListener((e=>{const t=Date.now();let n=!1;gStartingUp=!1,u=!0,e.onMessage.addListener((e=>{n="closedByEsc"==e})),e.onDisconnect.addListener((()=>{u=!1,!n&&Date.now()-t<450?x():i.pageview()}))})),chrome.runtime.onMessage.addListener((e=>{r.ShowTabCount.Key in e&&(b=e[r.ShowTabCount.Key],S().then((()=>T())))})),chrome.runtime.onUpdateAvailable.addListener((e=>{try{i.event("extension","update-available",e&&e.version)}catch(e){DEBUG&&console.log(e)}!function e(){u?setTimeout(e,1e4):(DEBUG&&console.log("=== reloading"),chrome.runtime.reload())}()})),window.log=function(...e){DEBUG&&console.log.apply(console,e)},a.get().then((e=>b=e[r.ShowTabCount.Key])).then((()=>S())).then((()=>e.tabs.query({}))).then((({length:e})=>T(e))),o.set((e=>(({lastUsedVersion:d,settings:{usePinyin:g}}=e),{lastStartupTime:Date.now(),lastUsedVersion:Manifest.version}))).then((()=>e.management.getSelf())).then((e=>{const t="development"==e.installType?"D":"P",o={dimension1:e.version,dimension2:t};"D"==t&&(r.IsDev=!0),i.set(o),n.popup.set(o),n.options.set(o),i.pageview(),i.timing("loading","background",performance.now()),DEBUG&&console.log("=== startup done",performance.now())})).then((()=>gInstalledPromise)).then((({reason:e,previousVersion:t})=>{i.event("extension",e,t),"update"==e&&"1.4.0"==d&&g&&(chrome.tabs.create({url:chrome.extension.getURL("options.html?pinyin")}),i.event("extension","open-options"))})).catch((e=>i.exception(e)))})),define("background/background",(function(){}));